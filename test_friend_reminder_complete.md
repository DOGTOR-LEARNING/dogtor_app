# 🔔 好友提醒功能測試指南

## 📋 功能概述

好友提醒功能允許用戶向其好友發送學習提醒通知，幫助好友保持學習習慣。

## ✅ 前置條件檢查

### 1. 後端服務狀態
- [ ] 後端服務正在運行
- [ ] 資料庫連接正常
- [ ] Firebase Admin SDK 已正確配置
- [ ] `user_tokens` 表存在
- [ ] `reminder_history` 表已創建

### 2. 前端應用設置
- [ ] Firebase 專案已正確配置
- [ ] 推送通知權限已請求
- [ ] FCM token 已成功註冊

## 🧪 測試步驟

### 第一階段：基礎功能測試

#### 1. 準備測試環境
```bash
# 1. 啟動後端服務
cd backend
source venv/bin/activate
python test_friend_reminder.py

# 2. 確認測試結果顯示：
# ✅ 所有測試通過 (4/4)
# 🎉 好友提醒功能基本正常！
```

#### 2. 用戶登入和好友設置
- [ ] 登入第一個測試帳號（發送者）
- [ ] 登入第二個測試帳號（接收者）
- [ ] 確保兩個帳號互為好友
- [ ] 確保接收者已允許推送通知權限

#### 3. 基本提醒測試
- [ ] 在發送者帳號中開啟好友檔案頁面
- [ ] 點擊右上角的鈴鐺圖示 🔔
- [ ] 觀察是否顯示發送中的載入動畫
- [ ] 確認是否收到成功/失敗的提示訊息

### 第二階段：邊界情況測試

#### 1. 頻率限制測試
- [ ] 連續發送 4 次提醒給同一好友
- [ ] 第 4 次應該顯示「24小時內提醒該好友多次」錯誤
- [ ] 等待 24 小時後應該可以再次發送

#### 2. 網路異常測試
- [ ] 關閉網路連接
- [ ] 嘗試發送提醒
- [ ] 確認顯示適當的錯誤訊息和重試選項

#### 3. 未註冊用戶測試
- [ ] 創建一個新用戶但不登入應用
- [ ] 向該用戶發送提醒
- [ ] 確認顯示「尚未註冊推送通知」的提示

### 第三階段：用戶體驗測試

#### 1. 視覺反饋測試
- [ ] 確認發送時有載入動畫
- [ ] 成功時有綠色提示和振動反饋
- [ ] 失敗時有紅色提示和不同強度的振動
- [ ] 錯誤對話框設計美觀且信息清晰

#### 2. 通知接收測試
- [ ] 確認接收者能夠收到推送通知
- [ ] 通知標題顯示「學習提醒」
- [ ] 通知內容包含發送者姓名
- [ ] 點擊通知可以正確打開應用

## 🐛 常見問題排解

### 問題 1: 無法發送提醒
**可能原因：**
- 接收者未登入應用
- 接收者未允許推送通知權限
- 網路連接問題

**解決方案：**
1. 確認接收者已登入應用並允許通知權限
2. 檢查網路連接
3. 查看後端日誌確認具體錯誤

### 問題 2: 收不到通知
**可能原因：**
- FCM token 過期或無效
- 設備通知設置被關閉
- 應用被系統省電模式限制

**解決方案：**
1. 重新登入應用刷新 token
2. 檢查設備通知設置
3. 將應用加入省電白名單

### 問題 3: 頻率限制不生效
**可能原因：**
- 資料庫時區設置問題
- reminder_history 表記錄有誤

**解決方案：**
1. 檢查資料庫時區設置
2. 查看 reminder_history 表記錄
3. 重新啟動後端服務

## 📊 測試記錄表

| 測試項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| 基礎發送功能 | 成功發送並顯示確認 | | ⏳ | |
| 頻率限制 | 超過3次後被限制 | | ⏳ | |
| 錯誤處理 | 顯示友好錯誤訊息 | | ⏳ | |
| 視覺反饋 | 載入動畫和振動 | | ⏳ | |
| 通知接收 | 成功接收推送通知 | | ⏳ | |

## 🔧 調試工具

### 後端日誌監控
```bash
# 查看學習提醒相關日誌
tail -f backend.log | grep -E "(📬|✅|❌|🔍)"
```

### 資料庫查詢
```sql
-- 查看用戶推送令牌
SELECT user_id, firebase_token, last_updated 
FROM user_tokens 
ORDER BY last_updated DESC;

-- 查看提醒歷史
SELECT user_id, sender_id, message, sent_at, success 
FROM reminder_history 
ORDER BY sent_at DESC 
LIMIT 10;
```

### 前端除錯
```dart
// 在 friend_profile_page.dart 中添加除錯日誌
print('🔔 發送提醒請求: ${widget.friend['user_id']}');
print('📱 當前用戶: ${currentUser.uid}');
```

## 🎯 測試完成標準

✅ **所有測試通過條件：**
1. 基礎發送功能正常工作
2. 頻率限制有效運作
3. 錯誤處理友好且準確
4. 視覺反饋流暢
5. 通知能夠正確送達和顯示
6. 日誌記錄完整且有助於調試

## 📞 技術支援

如果在測試過程中遇到問題，請：

1. 📋 記錄詳細的錯誤訊息和操作步驟
2. 🔍 檢查後端日誌和前端除錯訊息
3. 📊 查看資料庫記錄確認數據狀態
4. 🔄 嘗試重新啟動應用和後端服務

---

**最後更新：** 2024年12月
**版本：** v1.0
**作者：** 開發團隊 